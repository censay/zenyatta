#!/bin/bash
#
# zen-restore - Restore WIP from backup
# Usage: zen-restore [project-name]
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/lib/zen-core.sh"
source "${SCRIPT_DIR}/lib/zen-backup.sh"

# Check prerequisites
zen_check_not_in_container || exit 1
zen_check_setup || exit 1

# Get project name
PROJECT="${1:-}"

# If no project specified, use last project
if [[ -z "${PROJECT}" ]]; then
    PROJECT=$(zen_get_last_project)
    if [[ -z "${PROJECT}" ]]; then
        zen_error "No project specified and no previous project found"
        echo ""
        echo "Usage: zen-restore <project-name>"
        exit 1
    fi
    zen_info "Using last project: ${PROJECT}"
fi

BACKUP_FILE="${ZEN_BACKUP}/${PROJECT}-repobak.tar.gz"
WIP_DIR="${ZEN_WIP}/${PROJECT}"

if [[ ! -f "${BACKUP_FILE}" ]]; then
    zen_error "Backup not found: ${BACKUP_FILE}"
    echo ""
    echo "ðŸ’¡ Create a backup first: zen-backup ${PROJECT}"
    exit 1
fi

echo "ðŸ”„ Restoring from backup"
zen_divider
echo "Backup: ${BACKUP_FILE}"
echo "Target: ${WIP_DIR}"
echo ""

# Confirm
read -p "This will overwrite current WIP. Continue? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Cancelled"
    exit 1
fi

# Restore
if zen_backup_restore "${PROJECT}"; then
    echo ""
    zen_success "Restored from backup"
    echo ""
    echo "Next steps:"
    echo "  playground              # Enter container"
    echo "  cd /WIP-ai/${PROJECT}   # Navigate to restored project"
fi

# Return to WIP directory
cd "${WIP_DIR}"
