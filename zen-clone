#!/bin/bash
#
# zen-clone - Clone repository from GitHub
# Usage: zen-clone <repo-name>
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/lib/zen-core.sh"

# Check prerequisites
zen_check_not_in_container || exit 1
zen_check_setup || exit 1

# Get repo name
REPO="${1:-}"

if [[ -z "${REPO}" ]]; then
    echo "Usage: zen-clone <repo-name>"
    echo ""
    echo "Clones github.com/<user>/<repo> into ~/ai-playground/repos/"
    echo ""
    echo "Current repos:"
    ls -1 "${ZEN_REPOS}" 2>/dev/null | sed 's/^/  /' || echo "  (none)"
    exit 1
fi

# Get GitHub username
GITHUB_USER_FILE="${ZEN_HOME}/.zen-github-user"
if [[ ! -f "${GITHUB_USER_FILE}" ]]; then
    zen_error "No GitHub username configured"
    echo ""
    echo "ðŸ’¡ Set it with:"
    echo "   echo 'yourusername' > ${GITHUB_USER_FILE}"
    exit 1
fi

GITHUB_USER=$(cat "${GITHUB_USER_FILE}")

# Check if already exists
if [[ -d "${ZEN_REPOS}/${REPO}" ]]; then
    zen_error "Repository already exists: ${ZEN_REPOS}/${REPO}"
    echo ""
    echo "ðŸ’¡ To update: cd ${ZEN_REPOS}/${REPO} && git pull"
    exit 1
fi

echo "ðŸ“¥ Cloning from GitHub"
zen_divider
echo "From: git@github.com:${GITHUB_USER}/${REPO}.git"
echo "To:   ${ZEN_REPOS}/${REPO}"
echo ""

# Clone
cd "${ZEN_REPOS}"
if git clone "git@github.com:${GITHUB_USER}/${REPO}.git"; then
    zen_success "Cloned ${REPO}"
    echo ""
    echo "Next steps:"
    echo "  cd ${ZEN_REPOS}/${REPO}"
    echo "  git checkout -b ai/feature-name"
    echo "  zen-push ${REPO}"
    
    # Save as last project
    zen_set_last_project "${REPO}"
else
    zen_error "Clone failed"
    exit 1
fi
