#!/bin/bash
#
# zen-doctor - Check Zenyatta setup health
# Usage: zen-doctor
#

set -euo pipefail

echo "ğŸ©º Zenyatta Doctor"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

ISSUES=0

# Check 1: In correct directory
if [[ "$(pwd)" != "${HOME}/zenyatta" ]]; then
    echo "âš ï¸  Not in ~/zenyatta/ directory"
    echo "   Current: $(pwd)"
    echo "   Fix: cd ~/zenyatta"
    ((ISSUES++))
else
    echo "âœ… In correct directory"
fi

# Check 2: Aliases loaded
if ! type zen-help &>/dev/null; then
    echo ""
    echo "âŒ Commands not loaded"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "The zen-* commands are not available in this shell."
    echo ""
    echo "Fix by running ONE of these:"
    echo "  1. source ~/.bashrc           (recommended)"
    echo "  2. Open a new terminal"
    echo ""
    echo "Or run scripts directly:"
    echo "  ./zen-help"
    echo "  ./zen-status"
    echo ""
    ((ISSUES++))
else
    echo "âœ… Commands loaded"
fi

# Check 3: Workspace exists
if [[ ! -d "${HOME}/ai-playground" ]]; then
    echo "âš ï¸  Workspace not found: ~/ai-playground/"
    echo "   Fix: Re-run setup.sh"
    ((ISSUES++))
else
    echo "âœ… Workspace exists"
fi

# Check 4: Podman installed
if ! command -v podman &>/dev/null; then
    echo "âŒ Podman not installed"
    echo "   Fix: sudo apt install podman podman-compose"
    ((ISSUES++))
else
    echo "âœ… Podman installed"
fi

# Check 5: Meld installed
if ! command -v meld &>/dev/null; then
    echo "âš ï¸  Meld not installed (needed for zen-meld)"
    echo "   Fix: sudo apt install meld"
    ((ISSUES++))
else
    echo "âœ… Meld installed"
fi

# Check 6: Container status
echo ""
echo "ğŸ“¦ Container Status"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
if command -v podman &>/dev/null; then
    if podman ps | grep -q zenyatta; then
        echo "âœ… Container running"
    elif podman ps -a | grep -q zenyatta; then
        echo "â¹ï¸  Container stopped (run: zen-start)"
    else
        echo "âš ï¸  Container not created (run: zen-start)"
    fi
else
    echo "âŒ Cannot check (podman not installed)"
fi

# Check 7: Projects
echo ""
echo "ğŸ“ Projects"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
REPO_COUNT=$(ls -1 "${HOME}/ai-playground/repos" 2>/dev/null | wc -l)
echo "Repos: ${REPO_COUNT}"
if [[ ${REPO_COUNT} -gt 0 ]]; then
    ls -1 "${HOME}/ai-playground/repos" 2>/dev/null | head -5 | sed 's/^/  - /'
fi

# Check 8: Backups
echo ""
echo "ğŸ’¾ Backups"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
if [[ -d "${HOME}/ai-playground/backup" ]]; then
    BACKUP_COUNT=$(ls -1 "${HOME}/ai-playground/backup"/*-repobak.tar.gz 2>/dev/null | wc -l)
    echo "Found: ${BACKUP_COUNT} backup(s)"
else
    echo "No backups yet (created automatically by zen-meld)"
fi

# Summary
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [[ ${ISSUES} -eq 0 ]]; then
    echo "âœ… All checks passed!"
    echo ""
    echo "Ready to use. Try:"
    echo "  zen-help       # Show commands"
    echo "  zen-status     # Full status"
    echo "  zen-workflow   # See example"
else
    echo "âš ï¸  Found ${ISSUES} issue(s)"
    echo ""
    echo "Fix the issues above, then run: zen-doctor"
fi
